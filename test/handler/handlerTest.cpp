#include "environment.hpp"
#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include "handler.hpp"

using ::testing::Pair;
using ::testing::UnorderedElementsAre;
class HttpClientMock : public HttpClient {
   public:
    MOCK_METHOD(int, doPostToSlack, (std::string const &url, std::string const &token, std::string const &msg), (override));
    MOCK_METHOD(nlohmann::json, doGetSecretParameter, (std::string const &url, std::string const &token, Params const &params), (override));
};
class EnvironmentMock : public Environment {
   public:
    EnvironmentMock() : Environment() {
        oAuthKey = std::make_unique<Var<std::string>>("OAUTH_TOKEN_KEY", "");
        slackChannel = std::make_unique<Var<std::string>>("SLACK_CHANNEL", "");
        awsSessionToken = std::make_unique<Var<std::string>>("AWS_SESSION_TOKEN", "");
        thresHold = std::make_unique<Var<double>>("THRESHOLD", 0.0);
        onlyLatest = std::make_unique<Var<bool>>("ONLYLATEST", false);
        awsHealthEnventsToSkip = std::make_unique<Var<std::string>>("AWS_HEALTH_EVENTS_TO_SKIP", "");
        if (awsHealthEnventsToSkip->get().size() > 0) {
            eventTypes = getStrings(awsHealthEnventsToSkip->get(), ",");
        }
    };
    MOCK_METHOD(std::string, slackOAuthToken, (), (override));
};

class TestHandler : public Handler {
   public:
    TestHandler(std::shared_ptr<HttpClient> httpClient, Environment &env) : Handler(httpClient, env) {}
};

TEST(Handler, Should_return_cloudwatch_alarm_slack_messge) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"AlarmName\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS CloudWatch Notification"));
}

TEST(Handler, Should_return_guardduty_alert_slack_messge) {
    std::string msg = "{\"version\":\"0\",\"id\":\"637a68e4-245a-223c-1c34-148f6186445b\",\"detail-type\":\"GuardDutyFinding\",\"source\":\"aws.guardduty\",\"account\":\"XXXXXXXXXX\",\"time\":\"2024-03-14T10:30:06Z\",\"region\":\"eu-west-1\",\"resources\":[],\"detail\":{\"schemaVersion\":\"2.0\",\"accountId\":\"XXXXXXXXXX\",\"region\":\"eu-west-1\",\"partition\":\"aws\",\"id\":\"dac71e4142943d6e75716a060b77dd3a\",\"arn\":\"arn:aws:guardduty:eu-west-1:XXXXXXXXXX:detector/66ecf2448b5c4672bb2e7d786d817d79/finding/dac71e4142943d6e75716a060b77dd3a\",\"type\":\"Impact:S3/AnomalousBehavior.Write\",\"resource\":{\"resourceType\":\"S3Bucket\",\"accessKeyDetails\":{\"accessKeyId\":\"YYYYYYYYYYYYYYYYYYYYY\",\"principalId\":\"XXXXXXXXXXXXXXXXXXXX\",\"userType\":\"IAMUser\",\"userName\":\"Yyy-zzzzzzz-rr\"},\"s3BucketDetails\":[{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Destination\"},{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Source\"}]},\"service\":{\"serviceName\":\"guardduty\",\"detectorId\":\"66ecf2448b5c4672bb2e7d786d817d79\",\"action\":{\"actionType\":\"AWS_API_CALL\",\"awsApiCallAction\":{\"api\":\"CopyObject\",\"serviceName\":\"s3.amazonaws.com\",\"callerType\":\"RemoteIP\",\"remoteIpDetails\":{\"ipAddressV4\":\"123.123.123.123\",\"organization\":{\"asn\":\"1010\",\"asnOrg\":\"hostnet\",\"isp\":\"ispnet\",\"org\":\"ispnet\"},\"country\":{\"countryName\":\"Sweden\"},\"city\":{\"cityName\":\"H\\u00e4gersten\"},\"geoLocation\":{\"lat\":11.11111,\"lon\":22.2222}},\"affectedResources\":{\"AWS::S3::Bucket\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\"}}},\"resourceRole\":\"TARGET\",\"additionalInfo\":{\"userAgent\":{\"fullUserAgent\":\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\",\"userAgentCategory\":\"aws-sdk-s3\"},\"authenticationMethod\":\"AuthHeader\",\"anomalies\":{\"anomalousAPIs\":\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\"},\"profiledBehavior\":{\"rareProfiledAPIsAccountProfiling\":\"GetObjectAcl,ListObjectVersions,PutObjectTagging\",\"infrequentProfiledAPIsAccountProfiling\":\"\",\"frequentProfiledAPIsAccountProfiling\":\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\",\"rareProfiledAPIsUserIdentityProfiling\":\"\",\"infrequentProfiledAPIsUserIdentityProfiling\":\"\",\"frequentProfiledAPIsUserIdentityProfiling\":\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\",\"rareProfiledUserTypesAccountProfiling\":\"\",\"infrequentProfiledUserTypesAccountProfiling\":\"\",\"frequentProfiledUserTypesAccountProfiling\":\"IAMUser,AWSService,AssumedRole,AWSAccount\",\"rareProfiledUserNamesAccountProfiling\":\"\",\"infrequentProfiledUserNamesAccountProfiling\":\"\",\"frequentProfiledUserNamesAccountProfiling\":\"cdcdcd-general-alb-ddd-activation-waf-waf-fh\",\"rareProfiledUserNamesBucketProfiling\":\"\",\"infrequentProfiledUserNamesBucketProfiling\":\"\",\"frequentProfiledUserNamesBucketProfiling\":\"Yyy-zzzzzzz-rr,ddd-dev-s3\",\"rareProfiledASNsAccountProfiling\":\"asnNumber:11111asnOrg:band2ABasnNumber:12345asnOrg:InternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:1234asnOrg:qqqcccAS\",\"infrequentProfiledASNsAccountProfiling\":\"asnNumber:1010asnOrg:hostnetasnNumber:1234asnOrg:CompABasnNumber:12345asnOrg:DataInternetworkAB\",\"frequentProfiledASNsAccountProfiling\":\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:1234asnOrg:CompanyAB\",\"rareProfiledASNsUserIdentityProfiling\":\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccAS\",\"infrequentProfiledASNsUserIdentityProfiling\":\"\",\"frequentProfiledASNsUserIdentityProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\",\"rareProfiledASNsBucketProfiling\":\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccASasnNumber:2222asnOrg:compAB\",\"infrequentProfiledASNsBucketProfiling\":\"asnNumber:16509asnOrg:AMAZON-02\",\"frequentProfiledASNsBucketProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\",\"rareProfiledUserAgentsAccountProfiling\":\"\",\"infrequentProfiledUserAgentsAccountProfiling\":\"\",\"frequentProfiledUserAgentsAccountProfiling\":\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\",\"rareProfiledUserAgentsUserIdentityProfiling\":\"\",\"infrequentProfiledUserAgentsUserIdentityProfiling\":\"\",\"frequentProfiledUserAgentsUserIdentityProfiling\":\"aws-sdk-s3,AWSInternal\",\"rareProfiledBucketsAccountProfiling\":\"\",\"infrequentProfiledBucketsAccountProfiling\":\"\",\"frequentProfiledBucketsAccountProfiling\":\"Ddd-eeee-tttttt-ssssssss\",\"rareProfiledBucketsUserIdentityProfiling\":\"\",\"infrequentProfiledBucketsUserIdentityProfiling\":\"\",\"frequentProfiledBucketsUserIdentityProfiling\":\"Ddd-eeee-tttttt-ssssssss,dd-ooo-dev-stage-tests,dd-ooo-general-stagedds-archive,dd-ooo-general-stage-custom-reporting-mrm\"},\"unusualBehavior\":{\"unusualAPIsAccountProfiling\":\"\",\"unusualUserTypesAccountProfiling\":\"\",\"unusualUserNamesAccountProfiling\":\"\",\"unusualASNsAccountProfiling\":\"\",\"unusualUserAgentsAccountProfiling\":\"\",\"unusualBucketsAccountProfiling\":\"\",\"unusualAPIsUserIdentityProfiling\":\"\",\"unusualUserNamesBucketProfiling\":\"\",\"unusualASNsUserIdentityProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualASNsBucketProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualUserAgentsUserIdentityProfiling\":\"\",\"unusualBucketsUserIdentityProfiling\":\"\",\"isUnusualUserIdentity\":\"false\"},\"value\":\"{\\\"userAgent\\\":{\\\"fullUserAgent\\\":\\\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\\\",\\\"userAgentCategory\\\":\\\"aws-sdk-s3\\\"},\\\"authenticationMethod\\\":\\\"AuthHeader\\\",\\\"anomalies\\\":{\\\"anomalousAPIs\\\":\\\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\\\"},\\\"profiledBehavior\\\":{\\\"rareProfiledAPIsAccountProfiling\\\":\\\"GetObjectAcl,ListObjectVersions,PutObjectTagging\\\",\\\"infrequentProfiledAPIsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsAccountProfiling\\\":\\\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\\\",\\\"rareProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsUserIdentityProfiling\\\":\\\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\\\",\\\"rareProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserTypesAccountProfiling\\\":\\\"IAMUser,AWSService,AssumedRole,AWSAccount\\\",\\\"rareProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesAccountProfiling\\\":\\\"xxxmmstitlesync-stage-alb-xxx-mms-title-sync-waf-fh\\\",\\\"rareProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesBucketProfiling\\\":\\\"Yyy-zzzzzzz-rr,ddd-dev-s3\\\",\\\"rareProfiledASNsAccountProfiling\\\":\\\"asnNumber:11111asnOrg:band2ABasnNumber:12345asnOrg:InternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:1234asnOrg:qqqcccAS\\\",\\\"infrequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:1010asnOrg:hostnetasnNumber:1234asnOrg:CompABasnNumber:12345asnOrg:DataInternetworkAB\\\",\\\"frequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccAS\\\",\\\"infrequentProfiledASNsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledASNsBucketProfiling\\\":\\\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccASasnNumber:2222asnOrg:compAB\\\",\\\"infrequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:16509asnOrg:AMAZON-02\\\",\\\"frequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsAccountProfiling\\\":\\\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\\\",\\\"rareProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"aws-sdk-s3,AWSInternal\\\",\\\"rareProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsAccountProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\",\\\"rareProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsUserIdentityProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\"},\\\"unusualBehavior\\\":{\\\"unusualAPIsAccountProfiling\\\":\\\"\\\",\\\"unusualUserTypesAccountProfiling\\\":\\\"\\\",\\\"unusualUserNamesAccountProfiling\\\":\\\"\\\",\\\"unusualASNsAccountProfiling\\\":\\\"\\\",\\\"unusualUserAgentsAccountProfiling\\\":\\\"\\\",\\\"unusualBucketsAccountProfiling\\\":\\\"\\\",\\\"unusualAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualUserNamesBucketProfiling\\\":\\\"\\\",\\\"unusualASNsUserIdentityProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualASNsBucketProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"isUnusualUserIdentity\\\":\\\"false\\\"}}\",\"type\":\"default\"},\"eventFirstSeen\":\"2024-03-14T10:20:10.000Z\",\"eventLastSeen\":\"2024-03-14T10:20:10.000Z\",\"archived\":false,\"count\":1},\"severity\":5,\"createdAt\":\"2024-03-14T10:29:36.180Z\",\"updatedAt\":\"2024-03-14T10:29:36.180Z\",\"title\":\"An IAM entity invoked an API that attempts to write into the S3 bucket in an unusual way.\",\"description\":\"Principal Yyy-zzzzzzz-rr wrote objects to the S3 bucket arn:aws:s3:::Ddd-eeee-tttttt-ssssssss in an unusual way.\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS GuardDuty Alert"));
}
TEST(Handler, Should_return_inspector_alarm_slack_messge) {
    std::string msg = "{\"version\":\"0\",\"id\":\"040bb590-3a12-353f-ecb1-05e54b0fbea7\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T19:20:25Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"ThoseusingWoodstoxtoparseXMLdatamaybevulnerabletoDenialofServiceattacks(DOS)ifDTDsupportisenabled.Iftheparserisrunningonusersuppliedinput,anattackermaysupplycontentthatcausestheparsertocrashbystackoverflow.Thiseffectmaysupportadenialofserviceattack.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,7:20:25PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,7:20:25PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=47434\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-40152\",\"vendorCreatedAt\":\"Sep16,2022,10:15:00AM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Nov25,2022,11:15:00AM\",\"vulnerabilityId\":\"CVE-2022-40152\",\"vulnerablePackages\":[{\"epoch\":0,\"filePath\":\"lib/woodstox-core-6.2.7.jar\",\"fixedInVersion\":\"6.4.0\",\"name\":\"com.fasterxml.woodstox:woodstox-core\",\"packageManager\":\"JAR\",\"remediation\":\"Updatewoodstox-coreto6.4.0\",\"version\":\"6.2.7\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsLambdaFunction\":{\"architectures\":[\"X86_64\"],\"codeSha256\":\"+EwrOrht2um4fdVCD73gj+O7HJIAUvUxi8AD0eKHSkc=\",\"executionRoleArn\":\"arn:aws:iam::111122223333:role/ExampleFunction-ExecutionRole\",\"functionName\":\"Example-function\",\"lastModifiedAt\":\"Nov7,2022,8:29:27PM\",\"packageType\":\"ZIP\",\"runtime\":\"JAVA_11\",\"version\":\"$LATEST\"}},\"id\":\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"tags\":{\"TargetAlias\":\"DeploymentStack\",\"SoftwareType\":\"Infrastructure\"},\"type\":\"AWS_LAMBDA_FUNCTION\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-40152-com.fasterxml.woodstox:woodstox-core\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,7:20:25PM\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("Inspector2 Finding"));
}

TEST(Handler, Should_return_aws_health_slack_messge) {
    std::string msg = "{\"version\": \"0\",\"id\": \"7bf73129-1428-4cd3-a780-95db273d1602\",\"detail-type\": \"AWS Health Event\",\"source\": \"aws.health\",\"account\": \"123456789012\",\"time\": \"2023-01-27T09:01:22Z\",\"region\": \"af-south-1\",\"resources\": [],\"detail\": {\"eventArn\": \"arn:aws:health:af-south-1::event/EC2/AWS_EC2_OPERATIONAL_ISSUE/AWS_EC2_OPERATIONAL_ISSUE_7f35c8ae-af1f-54e6-a526-d0179ed6d68f\", \"service\": \"EC2\",\"eventTypeCode\": \"AWS_EC2_OPERATIONAL_ISSUE\",\"eventTypeCategory\": \"issue\",\"eventScopeCode\": \"PUBLIC\",\"communicationId\": \"01b0993207d81a09dcd552ebd1e633e36cf1f09a-1\",\"startTime\": \"Fri, 27 Jan 2023 06:02:51 GMT\",\"endTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\", \"lastUpdatedTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\",\"statusCode\": \"open\",\"eventRegion\": \"af-south-1\",\"eventDescription\":[{ \"language\": \"en_US\",\"latestDescription\": \"Current severity level: Operating normally [RESOLVED]  [03:15 PM PST] We continue see recovery The following AWS services were previously impacted but are now operating normally: APPSYNC, BACKUP, EVENTS.\"}],\"affectedEntities\":[],\"page\": \"1\", \"totalPages\": \"1\", \"affectedAccount\": \"123456789012\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS health information"));
}

TEST(Handler, Should_skip_aws_health_slack_messge_if_in_skip_list) {
    setenv("AWS_HEALTH_EVENTS_TO_SKIP", "AWS_EC2_OPERATIONAL_ISSUE", 0);
    std::string msg = "{\"version\": \"0\",\"id\": \"7bf73129-1428-4cd3-a780-95db273d1602\",\"detail-type\": \"AWS Health Event\",\"source\": \"aws.health\",\"account\": \"123456789012\",\"time\": \"2023-01-27T09:01:22Z\",\"region\": \"af-south-1\",\"resources\": [],\"detail\": {\"eventArn\": \"arn:aws:health:af-south-1::event/EC2/AWS_EC2_OPERATIONAL_ISSUE/AWS_EC2_OPERATIONAL_ISSUE_7f35c8ae-af1f-54e6-a526-d0179ed6d68f\", \"service\": \"EC2\",\"eventTypeCode\": \"AWS_EC2_OPERATIONAL_ISSUE\",\"eventTypeCategory\": \"issue\",\"eventScopeCode\": \"PUBLIC\",\"communicationId\": \"01b0993207d81a09dcd552ebd1e633e36cf1f09a-1\",\"startTime\": \"Fri, 27 Jan 2023 06:02:51 GMT\",\"endTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\", \"lastUpdatedTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\",\"statusCode\": \"open\",\"eventRegion\": \"af-south-1\",\"eventDescription\":[{ \"language\": \"en_US\",\"latestDescription\": \"Current severity level: Operating normally [RESOLVED]  [03:15 PM PST] We continue see recovery The following AWS services were previously impacted but are now operating normally: APPSYNC, BACKUP, EVENTS.\"}],\"affectedEntities\":[],\"page\": \"1\", \"totalPages\": \"1\", \"affectedAccount\": \"123456789012\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_FALSE(m.has_value());
}

TEST(Handler, Should_return_default_slack_massage_if_unknown_event) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"Unknown\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_FALSE(m.has_value());
}

TEST(Handler, process_payload) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"AlarmName\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    auto ssmParameter = nlohmann::json::object({{"Parameter", {{"Value", "secret_slack_key"}}}});
    auto mock = std::make_shared<HttpClientMock>();
    EnvironmentMock env{};
    TestHandler h(mock, env);
    // EXPECT_CALL(env, slackOAuthToken()).Times(1).WillOnce(testing::Return("secret_slack_key"));
    //  EXPECT_CALL(*mock, doGetSecretParameter("http://localhost:2773/systemsmanager/parameters/get", testing::_, testing::_)).Times(1).WillOnce(testing::Return(ssmParameter));
    EXPECT_CALL(*mock, doPostToSlack(testing::_, "", testing::_)).Times(1);
    h.process(msg);
}

TEST(Handler, set_error_message_on_failed_parseAndCreate) {
    std::string msg = "[1,2,3,]";  // create an invalid json string
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_TRUE(m.has_value());
    ASSERT_THAT(m.value(), testing::HasSubstr("Error parsing"));
}