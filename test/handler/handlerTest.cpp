#include "environment.hpp"
#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include "handler.hpp"

using ::testing::Pair;
using ::testing::UnorderedElementsAre;
class HttpClientMock : public HttpClient {
   public:
    MOCK_METHOD(int, doPostToSlack, (std::string const &url, std::string const &token, std::string const &msg), (override));
    MOCK_METHOD(nlohmann::json, doGetSecretParameter, (std::string const &url, std::string const &token, Params const &params), (override));
};
class EnvironmentMock : public Environment {
   public:
    EnvironmentMock() : Environment() {
        oAuthKey = std::make_unique<Var<std::string>>("OAUTH_TOKEN_KEY", "");
        slackChannel = std::make_unique<Var<std::string>>("SLACK_CHANNEL", "");
        awsSessionToken = std::make_unique<Var<std::string>>("AWS_SESSION_TOKEN", "");
        thresHold = std::make_unique<Var<double>>("THRESHOLD", 0.0);
        awsAccountName = std::make_unique<Var<std::string>>("AWS_ACCOUNT_NAME", "");
        onlyLatest = std::make_unique<Var<bool>>("ONLYLATEST", false);
        awsHealthEnventsToSkip = std::make_unique<Var<std::string>>("AWS_HEALTH_EVENTS_TO_SKIP", "");
        if (awsHealthEnventsToSkip->get().size() > 0) {
            eventTypes = getStrings(awsHealthEnventsToSkip->get(), ",");
        }
    };
    MOCK_METHOD(std::string, slackOAuthToken, (), (const, override));
};

class TestHandler : public Handler {
   public:
    TestHandler(std::shared_ptr<HttpClient> httpClient, Environment &env) : Handler(httpClient, env) {}
};

TEST(Handler, Should_handle_null_for_description_cloudwatch_alarm_slack_messge) {
    std::string msg = "{\n    \"Records\": [\n        {\n            \"EventSource\": \"aws:sns\",\n            \"EventVersion\": \"1.0\",\n            \"EventSubscriptionArn\": \"arn:aws:sns:eu-west-1:YYYYYYYYYYY:aws-alerts:a3762028-30dd-4369-bf79-da8d1d3d3a47\",\n            \"Sns\": {\n                \"Type\": \"Notification\",\n                \"MessageId\": \"5ae7c58b-970d-5345-b3a7-9b2aee917638\",\n                \"TopicArn\": \"arn:aws:sns:eu-west-1:YYYYYYYYYYY:aws-alerts\",\n                \"Subject\": \"ALARM: \\\"zzzzz-test-alarm\\\" in EU (Ireland)\",\n                \"Message\": \"{\\\"AlarmName\\\":\\\"zzzzz-test-alarm\\\",\\\"AlarmDescription\\\":null,\\\"AWSAccountId\\\":\\\"YYYYYYYYYYY\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2024-04-23T08:53:30.815+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"Threshold Crossed: 1 out of the last 1 datapoints [0.0 (23/04/24 08:53:00)] was less than the threshold (1000.0) (minimum 1 datapoint for OK -> ALARM transition).\\\",\\\"StateChangeTime\\\":\\\"2024-04-23T08:54:52.642+0000\\\",\\\"Region\\\":\\\"EU (Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:YYYYYYYYYYY:alarm:zzzzz-test-alarm\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:YYYYYYYYYYY:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"PendingTaskCount\\\",\\\"Namespace\\\":\\\"ECS/ContainerInsights\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"AVERAGE\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"ecssimple-test-myservice\\\",\\\"name\\\":\\\"ServiceName\\\"},{\\\"value\\\":\\\"coreecs-general-cluster-mrfd-main-ew1\\\",\\\"name\\\":\\\"ClusterName\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":1,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"LessThanThreshold\\\",\\\"Threshold\\\":1000.0,\\\"TreatMissingData\\\":\\\"breaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\n                \"Timestamp\": \"2024-04-23T08:54:52.709Z\",\n                \"SignatureVersion\": \"1\",\n                \"Signature\": \"pXkJPBv/ah5V9/0/kDHwYIGtttPH3fAdtA5UXYATBUwjXo6Nl4VCZFZrwTabcHLSDBI0ntbwgSlXY0/aumYxJ7YmxhK+NRA4OH2JYQ4Vo/ZB6PnPM8bK5NKPkq4oMkkER7QFxIpWk1NRfSVrpZatlh25skIG4Z1Y6Nv+CRjZmj4U9G+uC9Tgw8I0GW9zCOu7yk0YeXkD9PwNAHk5IMLVo1xac+a1UnoJPgRrR/VNdbIZfDtplRX5eJI3iEe+NNDdQq9n4kBu08T6AAJIe47p27OZW0p5VCxlfi0e/55l/UzSaCOmE4bkuDR+ww1bboWx5GnYDzd3H7XPXgiaHp7H1w==\",\n                \"SigningCertUrl\": \"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\n                \"UnsubscribeUrl\": \"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:YYYYYYYYYYY:aws-alerts:a3762984-31dd-1468-de45-da8d1d3d3a47\",\n                \"MessageAttributes\": {}\n            }\n        }\n    ]\n}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS CloudWatch Notification in region EU (Ireland)(YYYYYYYYYYY)"));
}

TEST(Handler, Should_handle_missing_inspector_score_for_slack_messge) {
    std::string msg = "{\n    \"version\": \"0\",\n    \"id\": \"b9112aa7-b17b-f18f-328a-a4d9734edd6b\",\n    \"detail-type\": \"Inspector2 Finding\",\n    \"source\": \"aws.inspector2\",\n    \"account\": \"123456789123\",\n    \"time\": \"2024-04-24T05:32:10Z\",\n    \"region\": \"eu-west-1\",\n    \"resources\": [\n        \"arn:aws:ecr:eu-west-1:123456789123:repository/data-api-app-primary/sha256:bd33b373bbf61d31ebccaaaa3bc1297437e25aeb1ef56785121f58235ed1ea61\"\n    ],\n    \"detail\": {\n        \"awsAccountId\": \"123456789123\",\n        \"description\": \"Issue summary: Some non-default TLS server configurations can cause unbounded\\nmemory growth when processing TLSv1.3 sessions\\n\\nImpact summary: An attacker may exploit certain server configurations to trigger\\nunbounded memory growth that would lead to a Denial of Service\\n\\nThis problem can occur in TLSv1.3 if the non-default SSL_OP_NO_TICKET option is\\nbeing used (but not if early_data support is also configured and the default\\nanti-replay protection is in use). In this case, under certain conditions, the\\nsession cache can get into an incorrect state and it will fail to flush properly\\nas it fills. The session cache will continue to grow in an unbounded manner. A\\nmalicious client could deliberately create the scenario for this failure to\\nforce a Denial of Service. It may also happen by accident in normal operation.\\n\\nThis issue only affects TLS servers supporting TLSv1.3. It does not affect TLS\\nclients.\\n\\nThe FIPS modules in 3.2, 3.1 and 3.0 are not affected by this issue. OpenSSL\\n1.0.2 is also not affected by this \",\n        \"epss\": {\n            \"score\": 0.00045\n        },\n        \"exploitAvailable\": \"YES\",\n        \"exploitabilityDetails\": {\n            \"lastKnownExploitAt\": \"Apr 20, 2024, 8:47:43 PM\"\n        },\n        \"findingArn\": \"arn:aws:inspector2:eu-west-1:123456789123:finding/6b1864ff51d03b7abcf94ea3f7a2305a\",\n        \"firstObservedAt\": \"Apr 22, 2024, 12:31:30 PM\",\n        \"fixAvailable\": \"NO\",\n        \"lastObservedAt\": \"Apr 22, 2024, 12:31:30 PM\",\n        \"packageVulnerabilityDetails\": {\n            \"cvss\": [],\n            \"referenceUrls\": [\n                \"https://github.openssl.org/openssl/extended-releases/commit/5f8d25770ae6437db119dfc951e207271a326640\",\n                \"https://www.openssl.org/news/secadv/20240408.txt\"\n            ],\n            \"relatedVulnerabilities\": [],\n            \"source\": \"NVD\",\n            \"sourceUrl\": \"https://nvd.nist.gov/vuln/detail/CVE-2024-2511\",\n            \"vendorCreatedAt\": \"Apr 8, 2024, 2:15:07 PM\",\n            \"vendorUpdatedAt\": \"Apr 8, 2024, 6:48:40 PM\",\n            \"vulnerabilityId\": \"CVE-2024-2511\",\n            \"vulnerablePackages\": [\n                {\n                    \"arch\": \"AARCH64\",\n                    \"epoch\": 0,\n                    \"fixedInVersion\": \"NotAvailable\",\n                    \"name\": \"openssl\",\n                    \"packageManager\": \"OS\",\n                    \"release\": \"r2\",\n                    \"remediation\": \"NotAvailable\",\n                    \"sourceLayerHash\": \"sha256:a9eaa45ef418e883481a13c7d84fa9904f2ec56789c52a87ba5a9e6483f2b74f\",\n                    \"version\": \"3.0.7\"\n                }\n            ]\n        },\n        \"remediation\": {\n            \"recommendation\": {\n                \"text\": \"None Provided\"\n            }\n        },\n        \"resources\": [\n            {\n                \"details\": {\n                    \"awsEcrContainerImage\": {\n                        \"architecture\": \"arm64\",\n                        \"imageHash\": \"sha256:bd33b373bbf61d31ebccaaaa3bc1297437e25aeb1ef56785121f58235ed1ea61\",\n                        \"imageTags\": [],\n                        \"platform\": \"ALPINE_LINUX_3_17\",\n                        \"pushedAt\": \"Apr 22, 2024, 12:29:25 PM\",\n                        \"registry\": \"123456789123\",\n                        \"repositoryName\": \"data-api-app-primary\"\n                    }\n                },\n                \"id\": \"arn:aws:ecr:eu-west-1:123456789123:repository/data-api-app-primary/sha256:bd33b373bbf61d31ebccaaaa3bc1297437e25aeb1ef56785121f58235ed1ea61\",\n                \"partition\": \"aws\",\n                \"region\": \"eu-west-1\",\n                \"type\": \"AWS_ECR_CONTAINER_IMAGE\"\n            }\n        ],\n        \"severity\": \"UNTRIAGED\",\n        \"status\": \"CLOSED\",\n        \"title\": \"CVE-2024-2511 - openssl\",\n        \"type\": \"PACKAGE_VULNERABILITY\",\n        \"updatedAt\": \"Apr 24, 2024, 5:32:10 AM\"\n    }\n}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("Inspector2 Finding"));
}

TEST(Handler, should_ignore_inspector_coverage_scan) {
    std::string msg = "{\n    \"version\": \"0\",\n    \"id\": \"becb5121-44b3-fda7-0132-f05886df925e\",\n    \"detail-type\": \"Inspector2 Coverage\",\n    \"source\": \"aws.inspector2\",\n    \"account\": \"123456789123\",\n    \"time\": \"2024-04-24T09:35:12Z\",\n    \"region\": \"eu-west-1\",\n    \"resources\": [\n        \"arn:aws:ecr:eu-west-1:123456789123:repository/server-general-worker-worker/sha256:63da9cbbc9af39a252b24048f65ae392305278e695261f9e2d62ed8881326\"\n    ],\n    \"detail\": {\n        \"awsAccountId\": \"123456789123\",\n        \"scanStatus\": {\n            \"reason\": \"SCAN_FREQUENCY_SCAN_ON_PUSH\",\n            \"statusCodeValue\": \"INACTIVE\"\n        },\n        \"scanType\": \"PACKAGE\",\n        \"eventTimestamp\": \"2024-04-24T09:35:03.137106Z\",\n        \"version\": \"1.0\"\n    }\n}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_FALSE(m.has_value());
}
TEST(Handler, TESTshould_ignore_inspector_ec2_scan) {
    std::string msg = "{\n    \"version\": \"0\",\n    \"id\": \"6863c9cb-7b18-1624-bc1b-ad23a7b9c10f\",\n    \"detail-type\": \"Inspector2 Finding\",\n    \"source\": \"aws.inspector2\",\n    \"account\": \"123456789123\",\n    \"time\": \"2024-04-24T09:35:02Z\",\n    \"region\": \"eu-west-1\",\n    \"resources\": [\n        \"arn:aws:ecr:eu-west-1:123456789123:repository/server-general-worker-worker/sha256:63da9cbbc9af39a252b24048f65ae392305278e695261f9e2d62ed8881326\"\n    ],\n    \"detail\": {\n        \"awsAccountId\": \"123456789123\",\n        \"description\": \"Issue summary: Checking excessively long DH keys or parameters may be very slow.  Impact summary: Applications that use the functions DH_check(), DH_check_ex() or EVP_PKEY_param_check() to check a DH key or DH parameters may experience long delays. Where the key or parameters that are being checked have been obtained from an untrusted source this may lead to a Denial of Service.  The function DH_check() performs various checks on DH parameters. One of those checks confirms that the modulus ('p' parameter) is not too large. Trying to use a very large modulus is slow and OpenSSL will not normally use a modulus which is over 10,000 bits in length.  However the DH_check() function checks numerous aspects of the key or parameters that have been supplied. Some of those checks use the supplied modulus value even if it has already been found to be too large.  An application that calls DH_check() and supplies a key or parameters obtained from an untrusted source could be vulernable to a Denial of Service attack.  The \",\n        \"epss\": {\n            \"score\": 0.00215\n        },\n        \"exploitAvailable\": \"YES\",\n        \"exploitabilityDetails\": {\n            \"lastKnownExploitAt\": \"Apr 18, 2024, 4:14:11 PM\"\n        },\n        \"findingArn\": \"arn:aws:inspector2:eu-west-1:123456789123:finding/1ee86aad6eda3938ae936b14eca7189c\",\n        \"firstObservedAt\": \"Apr 24, 2024, 9:35:02 AM\",\n        \"fixAvailable\": \"YES\",\n        \"inspectorScore\": 5.3,\n        \"inspectorScoreDetails\": {\n            \"adjustedCvss\": {\n                \"adjustments\": [],\n                \"cvssSource\": \"NVD\",\n                \"score\": 5.3,\n                \"scoreSource\": \"NVD\",\n                \"scoringVector\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L\",\n                \"version\": \"3.1\"\n            }\n        },\n        \"lastObservedAt\": \"Apr 24, 2024, 9:35:02 AM\",\n        \"packageVulnerabilityDetails\": {\n            \"cvss\": [\n                {\n                    \"baseScore\": 5.3,\n                    \"scoringVector\": \"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:L\",\n                    \"source\": \"NVD\",\n                    \"version\": \"3.1\"\n                }\n            ],\n            \"referenceUrls\": [\n                \"https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1041817\"\n            ],\n            \"relatedVulnerabilities\": [],\n            \"source\": \"DEBIAN_CVE\",\n            \"sourceUrl\": \"https://security-tracker.debian.org/tracker/CVE-2023-3446\",\n            \"vendorSeverity\": \"not yet assigned\",\n            \"vulnerabilityId\": \"CVE-2023-3446\",\n            \"vulnerablePackages\": [\n                {\n                    \"arch\": \"AMD64\",\n                    \"epoch\": 0,\n                    \"fixedInVersion\": \"0:1.1.1v-0~deb11u1\",\n                    \"name\": \"openssl\",\n                    \"packageManager\": \"OS\",\n                    \"release\": \"0+deb11u3\",\n                    \"remediation\": \"apt-get update && apt-get upgrade\",\n                    \"sourceLayerHash\": \"sha256:778656c04542093db6d3b6e07bffbcf6ec4b24709276be7cdf177fcb3666663a\",\n                    \"version\": \"1.1.1n\"\n                }\n            ]\n        },\n        \"remediation\": {\n            \"recommendation\": {\n                \"text\": \"None Provided\"\n            }\n        },\n        \"resources\": [\n            {\n                \"details\": {\n                    \"awsEcrContainerImage\": {\n                        \"architecture\": \"amd64\",\n                        \"imageHash\": \"sha256:63da9cbbc9af39a252b24048f65ae392305278e695261f9e2d62ed8881326\",\n                        \"imageTags\": [],\n                        \"platform\": \"DEBIAN_11\",\n                        \"pushedAt\": \"Apr 24, 2024, 9:34:50 AM\",\n                        \"registry\": \"123456789123\",\n                        \"repositoryName\": \"server-general-worker-worker\"\n                    }\n                },\n                \"id\": \"arn:aws:ecr:eu-west-1:123456789123:repository/server-general-worker-worker/sha256:63da9cbbc9af39a252b24048f65ae392305278e695261f9e2d62ed8881326\",\n                \"partition\": \"aws\",\n                \"region\": \"eu-west-1\",\n                \"type\": \"AWS_ECR_CONTAINER_IMAGE\"\n            }\n        ],\n        \"severity\": \"MEDIUM\",\n        \"status\": \"ACTIVE\",\n        \"title\": \"CVE-2023-3446 - openssl\",\n        \"type\": \"PACKAGE_VULNERABILITY\",\n        \"updatedAt\": \"Apr 24, 2024, 9:35:02 AM\"\n    }\n}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_TRUE(m.has_value());
}
TEST(Handler, Should_return_cloudwatch_alarm_slack_messge) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"AlarmName\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS CloudWatch Notification in region EU(Ireland)(XXXXXXXXXXX)"));
}

TEST(Handler, Should_return_guardduty_alert_slack_messge) {
    std::string msg = "{\"version\":\"0\",\"id\":\"637a68e4-245a-223c-1c34-148f6186445b\",\"detail-type\":\"GuardDutyFinding\",\"source\":\"aws.guardduty\",\"account\":\"XXXXXXXXXX\",\"time\":\"2024-03-14T10:30:06Z\",\"region\":\"eu-west-1\",\"resources\":[],\"detail\":{\"schemaVersion\":\"2.0\",\"accountId\":\"XXXXXXXXXX\",\"region\":\"eu-west-1\",\"partition\":\"aws\",\"id\":\"dac71e4142943d6e75716a060b77dd3a\",\"arn\":\"arn:aws:guardduty:eu-west-1:XXXXXXXXXX:detector/66ecf2448b5c4672bb2e7d786d817d79/finding/dac71e4142943d6e75716a060b77dd3a\",\"type\":\"Impact:S3/AnomalousBehavior.Write\",\"resource\":{\"resourceType\":\"S3Bucket\",\"accessKeyDetails\":{\"accessKeyId\":\"YYYYYYYYYYYYYYYYYYYYY\",\"principalId\":\"XXXXXXXXXXXXXXXXXXXX\",\"userType\":\"IAMUser\",\"userName\":\"Yyy-zzzzzzz-rr\"},\"s3BucketDetails\":[{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Destination\"},{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Source\"}]},\"service\":{\"serviceName\":\"guardduty\",\"detectorId\":\"66ecf2448b5c4672bb2e7d786d817d79\",\"action\":{\"actionType\":\"AWS_API_CALL\",\"awsApiCallAction\":{\"api\":\"CopyObject\",\"serviceName\":\"s3.amazonaws.com\",\"callerType\":\"RemoteIP\",\"remoteIpDetails\":{\"ipAddressV4\":\"123.123.123.123\",\"organization\":{\"asn\":\"1010\",\"asnOrg\":\"hostnet\",\"isp\":\"ispnet\",\"org\":\"ispnet\"},\"country\":{\"countryName\":\"Sweden\"},\"city\":{\"cityName\":\"H\\u00e4gersten\"},\"geoLocation\":{\"lat\":11.11111,\"lon\":22.2222}},\"affectedResources\":{\"AWS::S3::Bucket\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\"}}},\"resourceRole\":\"TARGET\",\"additionalInfo\":{\"userAgent\":{\"fullUserAgent\":\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\",\"userAgentCategory\":\"aws-sdk-s3\"},\"authenticationMethod\":\"AuthHeader\",\"anomalies\":{\"anomalousAPIs\":\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\"},\"profiledBehavior\":{\"rareProfiledAPIsAccountProfiling\":\"GetObjectAcl,ListObjectVersions,PutObjectTagging\",\"infrequentProfiledAPIsAccountProfiling\":\"\",\"frequentProfiledAPIsAccountProfiling\":\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\",\"rareProfiledAPIsUserIdentityProfiling\":\"\",\"infrequentProfiledAPIsUserIdentityProfiling\":\"\",\"frequentProfiledAPIsUserIdentityProfiling\":\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\",\"rareProfiledUserTypesAccountProfiling\":\"\",\"infrequentProfiledUserTypesAccountProfiling\":\"\",\"frequentProfiledUserTypesAccountProfiling\":\"IAMUser,AWSService,AssumedRole,AWSAccount\",\"rareProfiledUserNamesAccountProfiling\":\"\",\"infrequentProfiledUserNamesAccountProfiling\":\"\",\"frequentProfiledUserNamesAccountProfiling\":\"cdcdcd-general-alb-ddd-activation-waf-waf-fh\",\"rareProfiledUserNamesBucketProfiling\":\"\",\"infrequentProfiledUserNamesBucketProfiling\":\"\",\"frequentProfiledUserNamesBucketProfiling\":\"Yyy-zzzzzzz-rr,ddd-dev-s3\",\"rareProfiledASNsAccountProfiling\":\"asnNumber:11111asnOrg:band2ABasnNumber:12345asnOrg:InternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:1234asnOrg:qqqcccAS\",\"infrequentProfiledASNsAccountProfiling\":\"asnNumber:1010asnOrg:hostnetasnNumber:1234asnOrg:CompABasnNumber:12345asnOrg:DataInternetworkAB\",\"frequentProfiledASNsAccountProfiling\":\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:1234asnOrg:CompanyAB\",\"rareProfiledASNsUserIdentityProfiling\":\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccAS\",\"infrequentProfiledASNsUserIdentityProfiling\":\"\",\"frequentProfiledASNsUserIdentityProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\",\"rareProfiledASNsBucketProfiling\":\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccASasnNumber:2222asnOrg:compAB\",\"infrequentProfiledASNsBucketProfiling\":\"asnNumber:16509asnOrg:AMAZON-02\",\"frequentProfiledASNsBucketProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\",\"rareProfiledUserAgentsAccountProfiling\":\"\",\"infrequentProfiledUserAgentsAccountProfiling\":\"\",\"frequentProfiledUserAgentsAccountProfiling\":\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\",\"rareProfiledUserAgentsUserIdentityProfiling\":\"\",\"infrequentProfiledUserAgentsUserIdentityProfiling\":\"\",\"frequentProfiledUserAgentsUserIdentityProfiling\":\"aws-sdk-s3,AWSInternal\",\"rareProfiledBucketsAccountProfiling\":\"\",\"infrequentProfiledBucketsAccountProfiling\":\"\",\"frequentProfiledBucketsAccountProfiling\":\"Ddd-eeee-tttttt-ssssssss\",\"rareProfiledBucketsUserIdentityProfiling\":\"\",\"infrequentProfiledBucketsUserIdentityProfiling\":\"\",\"frequentProfiledBucketsUserIdentityProfiling\":\"Ddd-eeee-tttttt-ssssssss,dd-ooo-dev-stage-tests,dd-ooo-general-stagedds-archive,dd-ooo-general-stage-custom-reporting-mrm\"},\"unusualBehavior\":{\"unusualAPIsAccountProfiling\":\"\",\"unusualUserTypesAccountProfiling\":\"\",\"unusualUserNamesAccountProfiling\":\"\",\"unusualASNsAccountProfiling\":\"\",\"unusualUserAgentsAccountProfiling\":\"\",\"unusualBucketsAccountProfiling\":\"\",\"unusualAPIsUserIdentityProfiling\":\"\",\"unusualUserNamesBucketProfiling\":\"\",\"unusualASNsUserIdentityProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualASNsBucketProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualUserAgentsUserIdentityProfiling\":\"\",\"unusualBucketsUserIdentityProfiling\":\"\",\"isUnusualUserIdentity\":\"false\"},\"value\":\"{\\\"userAgent\\\":{\\\"fullUserAgent\\\":\\\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\\\",\\\"userAgentCategory\\\":\\\"aws-sdk-s3\\\"},\\\"authenticationMethod\\\":\\\"AuthHeader\\\",\\\"anomalies\\\":{\\\"anomalousAPIs\\\":\\\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\\\"},\\\"profiledBehavior\\\":{\\\"rareProfiledAPIsAccountProfiling\\\":\\\"GetObjectAcl,ListObjectVersions,PutObjectTagging\\\",\\\"infrequentProfiledAPIsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsAccountProfiling\\\":\\\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\\\",\\\"rareProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsUserIdentityProfiling\\\":\\\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\\\",\\\"rareProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserTypesAccountProfiling\\\":\\\"IAMUser,AWSService,AssumedRole,AWSAccount\\\",\\\"rareProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesAccountProfiling\\\":\\\"xxxmmstitlesync-stage-alb-xxx-mms-title-sync-waf-fh\\\",\\\"rareProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesBucketProfiling\\\":\\\"Yyy-zzzzzzz-rr,ddd-dev-s3\\\",\\\"rareProfiledASNsAccountProfiling\\\":\\\"asnNumber:11111asnOrg:band2ABasnNumber:12345asnOrg:InternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:1234asnOrg:qqqcccAS\\\",\\\"infrequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:1010asnOrg:hostnetasnNumber:1234asnOrg:CompABasnNumber:12345asnOrg:DataInternetworkAB\\\",\\\"frequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccAS\\\",\\\"infrequentProfiledASNsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledASNsBucketProfiling\\\":\\\"asnNumber:12345asnOrg:DataInternetworkABasnNumber:1234asnOrg:qqqcccASasnNumber:2222asnOrg:compAB\\\",\\\"infrequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:16509asnOrg:AMAZON-02\\\",\\\"frequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:1234asnOrg:CompanyAB\\\",\\\"rareProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsAccountProfiling\\\":\\\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\\\",\\\"rareProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"aws-sdk-s3,AWSInternal\\\",\\\"rareProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsAccountProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\",\\\"rareProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsUserIdentityProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\"},\\\"unusualBehavior\\\":{\\\"unusualAPIsAccountProfiling\\\":\\\"\\\",\\\"unusualUserTypesAccountProfiling\\\":\\\"\\\",\\\"unusualUserNamesAccountProfiling\\\":\\\"\\\",\\\"unusualASNsAccountProfiling\\\":\\\"\\\",\\\"unusualUserAgentsAccountProfiling\\\":\\\"\\\",\\\"unusualBucketsAccountProfiling\\\":\\\"\\\",\\\"unusualAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualUserNamesBucketProfiling\\\":\\\"\\\",\\\"unusualASNsUserIdentityProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualASNsBucketProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"isUnusualUserIdentity\\\":\\\"false\\\"}}\",\"type\":\"default\"},\"eventFirstSeen\":\"2024-03-14T10:20:10.000Z\",\"eventLastSeen\":\"2024-03-14T10:20:10.000Z\",\"archived\":false,\"count\":1},\"severity\":5,\"createdAt\":\"2024-03-14T10:29:36.180Z\",\"updatedAt\":\"2024-03-14T10:29:36.180Z\",\"title\":\"An IAM entity invoked an API that attempts to write into the S3 bucket in an unusual way.\",\"description\":\"Principal Yyy-zzzzzzz-rr wrote objects to the S3 bucket arn:aws:s3:::Ddd-eeee-tttttt-ssssssss in an unusual way.\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS GuardDuty Alert in region eu-west-1(XXXXXXXXXX)"));
}
TEST(Handler, Should_return_inspector_alarm_slack_messge) {
    std::string msg = "{\"version\":\"0\",\"id\":\"040bb590-3a12-353f-ecb1-05e54b0fbea7\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T19:20:25Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"ThoseusingWoodstoxtoparseXMLdatamaybevulnerabletoDenialofServiceattacks(DOS)ifDTDsupportisenabled.Iftheparserisrunningonusersuppliedinput,anattackermaysupplycontentthatcausestheparsertocrashbystackoverflow.Thiseffectmaysupportadenialofserviceattack.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,7:20:25PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,7:20:25PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=47434\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-40152\",\"vendorCreatedAt\":\"Sep16,2022,10:15:00AM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Nov25,2022,11:15:00AM\",\"vulnerabilityId\":\"CVE-2022-40152\",\"vulnerablePackages\":[{\"epoch\":0,\"filePath\":\"lib/woodstox-core-6.2.7.jar\",\"fixedInVersion\":\"6.4.0\",\"name\":\"com.fasterxml.woodstox:woodstox-core\",\"packageManager\":\"JAR\",\"remediation\":\"Updatewoodstox-coreto6.4.0\",\"version\":\"6.2.7\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsLambdaFunction\":{\"architectures\":[\"X86_64\"],\"codeSha256\":\"+EwrOrht2um4fdVCD73gj+O7HJIAUvUxi8AD0eKHSkc=\",\"executionRoleArn\":\"arn:aws:iam::111122223333:role/ExampleFunction-ExecutionRole\",\"functionName\":\"Example-function\",\"lastModifiedAt\":\"Nov7,2022,8:29:27PM\",\"packageType\":\"ZIP\",\"runtime\":\"JAVA_11\",\"version\":\"$LATEST\"}},\"id\":\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"tags\":{\"TargetAlias\":\"DeploymentStack\",\"SoftwareType\":\"Infrastructure\"},\"type\":\"AWS_LAMBDA_FUNCTION\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-40152-com.fasterxml.woodstox:woodstox-core\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,7:20:25PM\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("Inspector2 Finding"));
}

TEST(Handler, Should_return_aws_health_slack_messge) {
    std::string msg = "{\"version\": \"0\",\"id\": \"7bf73129-1428-4cd3-a780-95db273d1602\",\"detail-type\": \"AWS Health Event\",\"source\": \"aws.health\",\"account\": \"123456789012\",\"time\": \"2023-01-27T09:01:22Z\",\"region\": \"af-south-1\",\"resources\": [],\"detail\": {\"eventArn\": \"arn:aws:health:af-south-1::event/EC2/AWS_EC2_OPERATIONAL_ISSUE/AWS_EC2_OPERATIONAL_ISSUE_7f35c8ae-af1f-54e6-a526-d0179ed6d68f\", \"service\": \"EC2\",\"eventTypeCode\": \"AWS_EC2_OPERATIONAL_ISSUE\",\"eventTypeCategory\": \"issue\",\"eventScopeCode\": \"PUBLIC\",\"communicationId\": \"01b0993207d81a09dcd552ebd1e633e36cf1f09a-1\",\"startTime\": \"Fri, 27 Jan 2023 06:02:51 GMT\",\"endTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\", \"lastUpdatedTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\",\"statusCode\": \"open\",\"eventRegion\": \"af-south-1\",\"eventDescription\":[{ \"language\": \"en_US\",\"latestDescription\": \"Current severity level: Operating normally [RESOLVED]  [03:15 PM PST] We continue see recovery The following AWS services were previously impacted but are now operating normally: APPSYNC, BACKUP, EVENTS.\"}],\"affectedEntities\":[],\"page\": \"1\", \"totalPages\": \"1\", \"affectedAccount\": \"123456789012\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_THAT(m.value(), testing::HasSubstr("AWS health information"));
}

TEST(Handler, Should_skip_aws_health_slack_messge_if_in_skip_list) {
    setenv("AWS_HEALTH_EVENTS_TO_SKIP", "AWS_EC2_OPERATIONAL_ISSUE", 0);
    std::string msg = "{\"version\": \"0\",\"id\": \"7bf73129-1428-4cd3-a780-95db273d1602\",\"detail-type\": \"AWS Health Event\",\"source\": \"aws.health\",\"account\": \"123456789012\",\"time\": \"2023-01-27T09:01:22Z\",\"region\": \"af-south-1\",\"resources\": [],\"detail\": {\"eventArn\": \"arn:aws:health:af-south-1::event/EC2/AWS_EC2_OPERATIONAL_ISSUE/AWS_EC2_OPERATIONAL_ISSUE_7f35c8ae-af1f-54e6-a526-d0179ed6d68f\", \"service\": \"EC2\",\"eventTypeCode\": \"AWS_EC2_OPERATIONAL_ISSUE\",\"eventTypeCategory\": \"issue\",\"eventScopeCode\": \"PUBLIC\",\"communicationId\": \"01b0993207d81a09dcd552ebd1e633e36cf1f09a-1\",\"startTime\": \"Fri, 27 Jan 2023 06:02:51 GMT\",\"endTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\", \"lastUpdatedTime\": \"Fri, 27 Jan 2023 09:01:22 GMT\",\"statusCode\": \"open\",\"eventRegion\": \"af-south-1\",\"eventDescription\":[{ \"language\": \"en_US\",\"latestDescription\": \"Current severity level: Operating normally [RESOLVED]  [03:15 PM PST] We continue see recovery The following AWS services were previously impacted but are now operating normally: APPSYNC, BACKUP, EVENTS.\"}],\"affectedEntities\":[],\"page\": \"1\", \"totalPages\": \"1\", \"affectedAccount\": \"123456789012\"}}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_FALSE(m.has_value());
}

TEST(Handler, Should_return_default_slack_massage_if_unknown_event) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"Unknown\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_FALSE(m.has_value());
}

TEST(Handler, process_payload) {
    std::string msg = "{\"Records\":[{\"EventSource\":\"aws:sns\",\"EventVersion\":\"1.0\",\"EventSubscriptionArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"Sns\":{\"Type\":\"Notification\",\"MessageId\":\"XXXXXXXXXXX-yyyyyyyyyy-xzzddd-eeeee\",\"TopicArn\":\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\",\"Subject\":\"ALARM:\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rat...\\\"inEU(Ireland)\",\"Message\":\"{\\\"AlarmName\\\":\\\"AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"AlarmDescription\\\":\\\"AlarmforRate-basedruleeventsdetectedonRulealb-project-wafbase-rate-limit-rule\\\",\\\"AWSAccountId\\\":\\\"XXXXXXXXXXX\\\",\\\"AlarmConfigurationUpdatedTimestamp\\\":\\\"2023-02-23T12:07:38.685+0000\\\",\\\"NewStateValue\\\":\\\"ALARM\\\",\\\"NewStateReason\\\":\\\"ThresholdCrossed:1outofthelast20datapoints[613.0(16/03/2412:15:00)]wasgreaterthanorequaltothethreshold(1.0)and19missingdatapointsweretreatedas[NonBreaching](minimum1datapointforOK->ALARMtransition).\\\",\\\"StateChangeTime\\\":\\\"2024-03-16T12:16:45.770+0000\\\",\\\"Region\\\":\\\"EU(Ireland)\\\",\\\"AlarmArn\\\":\\\"arn:aws:cloudwatch:eu-west-1:XXXXXXXXXXX:alarm:AlarmForRBRule_project-general-alb-project_alb-project-wafbase-rate-limit-rule_BLOCK\\\",\\\"OldStateValue\\\":\\\"OK\\\",\\\"OKActions\\\":[],\\\"AlarmActions\\\":[\\\"arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts\\\"],\\\"InsufficientDataActions\\\":[],\\\"Trigger\\\":{\\\"MetricName\\\":\\\"BlockedRequests\\\",\\\"Namespace\\\":\\\"AWS/WAFV2\\\",\\\"StatisticType\\\":\\\"Statistic\\\",\\\"Statistic\\\":\\\"SUM\\\",\\\"Unit\\\":null,\\\"Dimensions\\\":[{\\\"value\\\":\\\"project-general-alb-project\\\",\\\"name\\\":\\\"WebACL\\\"},{\\\"value\\\":\\\"eu-west-1\\\",\\\"name\\\":\\\"Region\\\"},{\\\"value\\\":\\\"alb-project-wafbase-rate-limit-rule\\\",\\\"name\\\":\\\"Rule\\\"}],\\\"Period\\\":60,\\\"EvaluationPeriods\\\":20,\\\"DatapointsToAlarm\\\":1,\\\"ComparisonOperator\\\":\\\"GreaterThanOrEqualToThreshold\\\",\\\"Threshold\\\":1.0,\\\"TreatMissingData\\\":\\\"notBreaching\\\",\\\"EvaluateLowSampleCountPercentile\\\":\\\"\\\"}}\",\"Timestamp\":\"2024-03-16T12:16:45.815Z\",\"SignatureVersion\":\"1\",\"Signature\":\"Tw2QN/ba8DU1OzZpnurRJhBH+gz+1K6+oge4af3xid9o82+eIdafn23MWABUYhWfA3GK0JzZNH052dfP0AduM308vxpM5zA9sDYuDUvjtM3b7++GFHLG/2SzlNyekCMKAQPFCO5sz+VnLERq+i3m5onv29S7jcM78jqou3ArhCv/iHSWlzFKtpY0TvyC+VLhPbsNFuJ1ef/7sM3Q3M7BUX7ukg60337zkYXSQGHSSTTQAszbGzqQzkbt1LOLjAIk0s9yQ/yuHWQWnrfi+hjFERXrg9qGIPZ8L6AhZowu+JwidrmsLytehmiy2OKSKFpgRBM78V5bxjV4Y7BH9z+vUQ==\",\"SigningCertUrl\":\"https://sns.eu-west-1.amazonaws.com/SimpleNotificationService-60eadc530605d63b8e62a523676ef735.pem\",\"UnsubscribeUrl\":\"https://sns.eu-west-1.amazonaws.com/?Action=Unsubscribe&SubscriptionArn=arn:aws:sns:eu-west-1:XXXXXXXXXXX:aws-alerts:xxxxxxx-yyyy-zzzz-xxxxx-yyyyy\",\"MessageAttributes\":{}}}]}";
    auto ssmParameter = nlohmann::json::object({{"Parameter", {{"Value", "secret_slack_key"}}}});
    auto mock = std::make_shared<HttpClientMock>();
    EnvironmentMock env{};
    TestHandler h(mock, env);
    // EXPECT_CALL(env, slackOAuthToken()).Times(1).WillOnce(testing::Return("secret_slack_key"));
    //  EXPECT_CALL(*mock, doGetSecretParameter("http://localhost:2773/systemsmanager/parameters/get", testing::_, testing::_)).Times(1).WillOnce(testing::Return(ssmParameter));
    EXPECT_CALL(*mock, doPostToSlack(testing::_, "", testing::_)).Times(1);
    h.process(msg);
}

TEST(Handler, set_error_message_on_failed_parseAndCreate) {
    std::string msg = "[1,2,3,]";  // create an invalid json string
    HttpClient client;
    EnvironmentMock env{};
    Handler h(std::make_shared<HttpClient>(client), env);
    auto slack = h.parseAndCreateSlackMessage(msg, "slack_channel");
    auto m = slack->message();
    ASSERT_TRUE(m.has_value());
    ASSERT_THAT(m.value(), testing::HasSubstr("Error parsing"));
}