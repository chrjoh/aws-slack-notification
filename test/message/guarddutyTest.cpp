#include <nlohmann/json.hpp>

#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include "guardduty.hpp"

TEST(Guardduty, ensure_correct_slack_message) {
    std::string msg = "{\"version\":\"0\",\"id\":\"637a68e4-245a-223c-1c34-148f6186445b\",\"detail-type\":\"GuardDutyFinding\",\"source\":\"aws.guardduty\",\"account\":\"XXXXXXXXXX\",\"time\":\"2024-03-14T10:30:06Z\",\"region\":\"eu-west-1\",\"resources\":[],\"detail\":{\"schemaVersion\":\"2.0\",\"accountId\":\"XXXXXXXXXX\",\"region\":\"eu-west-1\",\"partition\":\"aws\",\"id\":\"dac71e414d9a34676c726d0e0bd7dd4a\",\"arn\":\"arn:aws:guardduty:eu-west-1:XXXXXXXXXX:detector/66ecf2448b5c4672bb2e7d786d817d79/finding/dac71e414d9a34676c726d0e0bd7dd4a\",\"type\":\"Impact:S3/AnomalousBehavior.Write\",\"resource\":{\"resourceType\":\"S3Bucket\",\"accessKeyDetails\":{\"accessKeyId\":\"YYYYYYYYYYYYYYYYYYYYY\",\"principalId\":\"XXXXXXXXXXXXXXXXXXXX\",\"userType\":\"IAMUser\",\"userName\":\"Yyy-zzzzzzz-rr\"},\"s3BucketDetails\":[{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Destination\"},{\"arn\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\",\"name\":\"Ddd-eeee-tttttt-ssssssss\",\"defaultServerSideEncryption\":{\"encryptionType\":\"AES256\",\"kmsMasterKeyArn\":null},\"createdAt\":1667908158,\"tags\":[],\"owner\":{\"id\":\"59d5445f6a60c291c324c5c9787880c5518b34357f4d4cf3138bcec9f9dde6bd\"},\"publicAccess\":{\"permissionConfiguration\":{\"bucketLevelPermissions\":{\"accessControlList\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"bucketPolicy\":{\"allowsPublicReadAccess\":false,\"allowsPublicWriteAccess\":false},\"blockPublicAccess\":{\"ignorePublicAcls\":true,\"restrictPublicBuckets\":true,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}},\"accountLevelPermissions\":{\"blockPublicAccess\":{\"ignorePublicAcls\":false,\"restrictPublicBuckets\":false,\"blockPublicAcls\":true,\"blockPublicPolicy\":true}}},\"effectivePermission\":\"NOT_PUBLIC\"},\"type\":\"Source\"}]},\"service\":{\"serviceName\":\"guardduty\",\"detectorId\":\"66ecf2448b5c4672bb2e7d786d817d79\",\"action\":{\"actionType\":\"AWS_API_CALL\",\"awsApiCallAction\":{\"api\":\"CopyObject\",\"serviceName\":\"s3.amazonaws.com\",\"callerType\":\"RemoteIP\",\"remoteIpDetails\":{\"ipAddressV4\":\"123.123.123.123\",\"organization\":{\"asn\":\"1010\",\"asnOrg\":\"hostnet\",\"isp\":\"ispnet\",\"org\":\"ispnet\"},\"country\":{\"countryName\":\"Sweden\"},\"city\":{\"cityName\":\"H\\u00e4gersten\"},\"geoLocation\":{\"lat\":11.11111,\"lon\":22.2222}},\"affectedResources\":{\"AWS::S3::Bucket\":\"arn:aws:s3:::Ddd-eeee-tttttt-ssssssss\"}}},\"resourceRole\":\"TARGET\",\"additionalInfo\":{\"userAgent\":{\"fullUserAgent\":\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\",\"userAgentCategory\":\"aws-sdk-s3\"},\"authenticationMethod\":\"AuthHeader\",\"anomalies\":{\"anomalousAPIs\":\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\"},\"profiledBehavior\":{\"rareProfiledAPIsAccountProfiling\":\"GetObjectAcl,ListObjectVersions,PutObjectTagging\",\"infrequentProfiledAPIsAccountProfiling\":\"\",\"frequentProfiledAPIsAccountProfiling\":\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\",\"rareProfiledAPIsUserIdentityProfiling\":\"\",\"infrequentProfiledAPIsUserIdentityProfiling\":\"\",\"frequentProfiledAPIsUserIdentityProfiling\":\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\",\"rareProfiledUserTypesAccountProfiling\":\"\",\"infrequentProfiledUserTypesAccountProfiling\":\"\",\"frequentProfiledUserTypesAccountProfiling\":\"IAMUser,AWSService,AssumedRole,AWSAccount\",\"rareProfiledUserNamesAccountProfiling\":\"\",\"infrequentProfiledUserNamesAccountProfiling\":\"\",\"frequentProfiledUserNamesAccountProfiling\":\"cdcdcd-general-alb-ddd-activation-waf-waf-fh\",\"rareProfiledUserNamesBucketProfiling\":\"\",\"infrequentProfiledUserNamesBucketProfiling\":\"\",\"frequentProfiledUserNamesBucketProfiling\":\"Yyy-zzzzzzz-rr,ddd-dev-s3\",\"rareProfiledASNsAccountProfiling\":\"asnNumber:29518asnOrg:Bredband2ABasnNumber:20940asnOrg:AkamaiInternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:2119asnOrg:TelenorNorgeAS\",\"infrequentProfiledASNsAccountProfiling\":\"asnNumber:1010asnOrg:hostnetasnNumber:8473asnOrg:BahnhofABasnNumber:13189asnOrg:LidenDataInternetworkAB\",\"frequentProfiledASNsAccountProfiling\":\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:3301asnOrg:TeliaCompanyAB\",\"rareProfiledASNsUserIdentityProfiling\":\"asnNumber:13189asnOrg:LidenDataInternetworkABasnNumber:2119asnOrg:TelenorNorgeAS\",\"infrequentProfiledASNsUserIdentityProfiling\":\"\",\"frequentProfiledASNsUserIdentityProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:3301asnOrg:TeliaCompanyAB\",\"rareProfiledASNsBucketProfiling\":\"asnNumber:13189asnOrg:LidenDataInternetworkABasnNumber:2119asnOrg:TelenorNorgeASasnNumber:8473asnOrg:BahnhofAB\",\"infrequentProfiledASNsBucketProfiling\":\"asnNumber:16509asnOrg:AMAZON-02\",\"frequentProfiledASNsBucketProfiling\":\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:3301asnOrg:TeliaCompanyAB\",\"rareProfiledUserAgentsAccountProfiling\":\"\",\"infrequentProfiledUserAgentsAccountProfiling\":\"\",\"frequentProfiledUserAgentsAccountProfiling\":\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\",\"rareProfiledUserAgentsUserIdentityProfiling\":\"\",\"infrequentProfiledUserAgentsUserIdentityProfiling\":\"\",\"frequentProfiledUserAgentsUserIdentityProfiling\":\"aws-sdk-s3,AWSInternal\",\"rareProfiledBucketsAccountProfiling\":\"\",\"infrequentProfiledBucketsAccountProfiling\":\"\",\"frequentProfiledBucketsAccountProfiling\":\"Ddd-eeee-tttttt-ssssssss\",\"rareProfiledBucketsUserIdentityProfiling\":\"\",\"infrequentProfiledBucketsUserIdentityProfiling\":\"\",\"frequentProfiledBucketsUserIdentityProfiling\":\"Ddd-eeee-tttttt-ssssssss,dd-ooo-dev-stage-tests,dd-ooo-general-stage-mms-archive,dd-ooo-general-stage-custom-reporting-mrm\"},\"unusualBehavior\":{\"unusualAPIsAccountProfiling\":\"\",\"unusualUserTypesAccountProfiling\":\"\",\"unusualUserNamesAccountProfiling\":\"\",\"unusualASNsAccountProfiling\":\"\",\"unusualUserAgentsAccountProfiling\":\"\",\"unusualBucketsAccountProfiling\":\"\",\"unusualAPIsUserIdentityProfiling\":\"\",\"unusualUserNamesBucketProfiling\":\"\",\"unusualASNsUserIdentityProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualASNsBucketProfiling\":\"asnNumber:1010asnOrg:hostnet\",\"unusualUserAgentsUserIdentityProfiling\":\"\",\"unusualBucketsUserIdentityProfiling\":\"\",\"isUnusualUserIdentity\":\"false\"},\"value\":\"{\\\"userAgent\\\":{\\\"fullUserAgent\\\":\\\"[aws-sdk-ruby3/3.114.0ruby/2.7.6arm64-darwin23aws-sdk-s3/1.93.1]\\\",\\\"userAgentCategory\\\":\\\"aws-sdk-s3\\\"},\\\"authenticationMethod\\\":\\\"AuthHeader\\\",\\\"anomalies\\\":{\\\"anomalousAPIs\\\":\\\"s3.amazonaws.com:[CopyObject:success,PutObject:success]\\\"},\\\"profiledBehavior\\\":{\\\"rareProfiledAPIsAccountProfiling\\\":\\\"GetObjectAcl,ListObjectVersions,PutObjectTagging\\\",\\\"infrequentProfiledAPIsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsAccountProfiling\\\":\\\"CopyObject,PutObject,ListObjects,GetObject,CreateMultipartUpload,DeleteObject,GetObjectTagging\\\",\\\"rareProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledAPIsUserIdentityProfiling\\\":\\\"CopyObject,PutObject,ListObjects,DeleteObject,GetObject\\\",\\\"rareProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserTypesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserTypesAccountProfiling\\\":\\\"IAMUser,AWSService,AssumedRole,AWSAccount\\\",\\\"rareProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesAccountProfiling\\\":\\\"xxxmmstitlesync-stage-alb-xxx-mms-title-sync-waf-fh\\\",\\\"rareProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserNamesBucketProfiling\\\":\\\"\\\",\\\"frequentProfiledUserNamesBucketProfiling\\\":\\\"Yyy-zzzzzzz-rr,ddd-dev-s3\\\",\\\"rareProfiledASNsAccountProfiling\\\":\\\"asnNumber:29518asnOrg:Bredband2ABasnNumber:20940asnOrg:AkamaiInternationalB.V.asnNumber:14618asnOrg:AMAZON-AESasnNumber:2119asnOrg:TelenorNorgeAS\\\",\\\"infrequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:1010asnOrg:hostnetasnNumber:8473asnOrg:BahnhofABasnNumber:13189asnOrg:LidenDataInternetworkAB\\\",\\\"frequentProfiledASNsAccountProfiling\\\":\\\"asnNumber:65534asnOrg:PRIVATEasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:16509asnOrg:AMAZON-02asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:8075asnOrg:MICROSOFT-CORP-MSN-AS-BLOCKasnNumber:3301asnOrg:TeliaCompanyAB\\\",\\\"rareProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:13189asnOrg:LidenDataInternetworkABasnNumber:2119asnOrg:TelenorNorgeAS\\\",\\\"infrequentProfiledASNsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledASNsUserIdentityProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:AMAZON-02asnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:3301asnOrg:TeliaCompanyAB\\\",\\\"rareProfiledASNsBucketProfiling\\\":\\\"asnNumber:13189asnOrg:LidenDataInternetworkABasnNumber:2119asnOrg:TelenorNorgeASasnNumber:8473asnOrg:BahnhofAB\\\",\\\"infrequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:16509asnOrg:AMAZON-02\\\",\\\"frequentProfiledASNsBucketProfiling\\\":\\\"asnNumber:396982asnOrg:GOOGLE-CLOUD-PLATFORMasnNumber:16509asnOrg:Amazon.com,Inc.asnNumber:3301asnOrg:TeliaCompanyAB\\\",\\\"rareProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsAccountProfiling\\\":\\\"aws-sdk-s3,aws-sdk-js,AWSService,OTHER,aws-sdk-nodejs,aws-internal,aws-sdk-go-v2,aws-sdk-go,AWSInternal,aws-cli,browser\\\",\\\"rareProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledUserAgentsUserIdentityProfiling\\\":\\\"aws-sdk-s3,AWSInternal\\\",\\\"rareProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsAccountProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsAccountProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\",\\\"rareProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"infrequentProfiledBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"frequentProfiledBucketsUserIdentityProfiling\\\":\\\"Ddd-eeee-tttttt-ssssssss\\\"},\\\"unusualBehavior\\\":{\\\"unusualAPIsAccountProfiling\\\":\\\"\\\",\\\"unusualUserTypesAccountProfiling\\\":\\\"\\\",\\\"unusualUserNamesAccountProfiling\\\":\\\"\\\",\\\"unusualASNsAccountProfiling\\\":\\\"\\\",\\\"unusualUserAgentsAccountProfiling\\\":\\\"\\\",\\\"unusualBucketsAccountProfiling\\\":\\\"\\\",\\\"unusualAPIsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualUserNamesBucketProfiling\\\":\\\"\\\",\\\"unusualASNsUserIdentityProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualASNsBucketProfiling\\\":\\\"asnNumber:1010asnOrg:hostnet\\\",\\\"unusualUserAgentsUserIdentityProfiling\\\":\\\"\\\",\\\"unusualBucketsUserIdentityProfiling\\\":\\\"\\\",\\\"isUnusualUserIdentity\\\":\\\"false\\\"}}\",\"type\":\"default\"},\"eventFirstSeen\":\"2024-03-14T10:20:10.000Z\",\"eventLastSeen\":\"2024-03-14T10:20:10.000Z\",\"archived\":false,\"count\":1},\"severity\":5,\"createdAt\":\"2024-03-14T10:29:36.180Z\",\"updatedAt\":\"2024-03-14T10:29:36.180Z\",\"title\":\"An IAM entity invoked an API that attempts to write into the S3 bucket in an unusual way.\",\"description\":\"Principal Yyy-zzzzzzz-rr wrote objects to the S3 bucket arn:aws:s3:::Ddd-eeee-tttttt-ssssssss in an unusual way.\"}}";
    std::string expected = "{\"attachments\":[{\"blocks\":[{\"text\":{\"text\":\"AWS GuardDuty Alert\",\"type\":\"plain_text\"},\"type\":\"header\"},{\"text\":{\"text\":\"*Alert title*\\nAn IAM entity invoked an API that attempts to write into the S3 bucket in an unusual way.\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"text\":{\"text\":\"*Severity*\\n5\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"text\":{\"text\":\"*Type*\\nImpact:S3/AnomalousBehavior.Write\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"text\":{\"text\":\"*Description*\\nPrincipal Yyy-zzzzzzz-rr wrote objects to the S3 bucket arn:aws:s3:::Ddd-eeee-tttttt-ssssssss in an unusual way.\",\"type\":\"mrkdwn\"},\"type\":\"section\"}],\"color\":\"#FF0000\"}],\"channel\":\"slack_channel\",\"text\":\"*AWS GuardDuty Alert in eu-west-1*\"}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Guardduty guardDuty{"slack_channel"};
    guardDuty.parse(jsonMessage);
    auto result = guardDuty.message();
    ASSERT_EQ(result.value(), expected);
}