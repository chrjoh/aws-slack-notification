#include <nlohmann/json.hpp>

#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include "inspector.hpp"

TEST(Inspector, ensure_corrct_slack_message) {
    std::string msg = "{\"version\":\"0\",\"id\":\"5b52952e-26df-3a51-6d14-4dbe737e58ec\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T21:59:00Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"libcurlwouldreuseapreviouslycreatedconnectionevenwhenaTLSorSSHrelatedoptionhadbeenchangedthatshouldhaveprohibitedreuse.libcurlkeepspreviouslyusedconnectionsinaconnectionpoolforsubsequenttransferstoreuseifoneofthemmatchesthesetup.However,severalTLSandSSHsettingswereleftoutfromtheconfigurationmatchchecks,makingthemmatchtooeasily.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,9:59:00PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"adjustments\":[],\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,9:59:00PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":5,\"scoringVector\":\"AV:N/AC:L/Au:N/C:N/I:P/A:N\",\"source\":\"NVD\",\"version\":\"2.0\"},{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://hackerone.com/reports/1555796\",\"https://security.gentoo.org/glsa/202212-01\",\"https://lists.debian.org/debian-lts-announce/2022/08/msg00017.html\",\"https://www.debian.org/security/2022/dsa-5197\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-27782\",\"vendorCreatedAt\":\"Jun2,2022,2:15:00PM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Jan5,2023,5:51:00PM\",\"vulnerabilityId\":\"CVE-2022-27782\",\"vulnerablePackages\":[{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"libcurl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatelibcurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"},{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"curl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatecurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsEcrContainerImage\":{\"architecture\":\"amd64\",\"imageHash\":\"sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"imageTags\":[\"o3\"],\"platform\":\"ORACLE_LINUX_8\",\"pushedAt\":\"Jan19,2023,7:38:39PM\",\"registry\":\"111122223333\",\"repositoryName\":\"inspector2\"}},\"id\":\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"type\":\"AWS_ECR_CONTAINER_IMAGE\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-27782-libcurl,curl\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,9:59:00PM\"}}";
    std::string expected = "{\"blocks\":[{\"text\":{\"text\":\"Inspector2 Finding for ECR image in region us-east-1(111122223333)\",\"type\":\"plain_text\"},\"type\":\"header\"},{\"text\":{\"text\":\"*Description*\\nlibcurlwouldreuseapreviouslycreatedconnectionevenwhenaTLSorSSHrelatedoptionhadbeenchangedthatshouldhaveprohibitedreuse.libcurlkeepspreviouslyusedconnectionsinaconnectionpoolforsubsequenttransferstoreuseifoneofthemmatchesthesetup.However,severalTLSandSSHsettingswereleftoutfromtheconfigurationmatchchecks,makingthemmatchtooeasily.\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"text\":{\"text\":\"*Vulnerability*\\nCVE-2022-27782-libcurl,curl\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"text\":{\"text\":\"*Resource*\\n`arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13`\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"fields\":[{\"text\":\"*Exploit available*\\nNO\",\"type\":\"mrkdwn\"},{\"text\":\"*Fix Available*\\nYES\",\"type\":\"mrkdwn\"},{\"text\":\"*Severity*\\nHIGH\",\"type\":\"mrkdwn\"},{\"text\":\"*Inspector score*\\n7.5\",\"type\":\"mrkdwn\"}],\"type\":\"section\"}],\"channel\":\"slack_channel\",\"text\":\"*Inspector2 Finding in us-east-1*\"}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_EQ(result.value(), expected);
}

TEST(Inspector, parse_inspector_ecr_finding) {
    std::string msg = "{\"version\":\"0\",\"id\":\"5b52952e-26df-3a51-6d14-4dbe737e58ec\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T21:59:00Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"libcurlwouldreuseapreviouslycreatedconnectionevenwhenaTLSorSSHrelatedoptionhadbeenchangedthatshouldhaveprohibitedreuse.libcurlkeepspreviouslyusedconnectionsinaconnectionpoolforsubsequenttransferstoreuseifoneofthemmatchesthesetup.However,severalTLSandSSHsettingswereleftoutfromtheconfigurationmatchchecks,makingthemmatchtooeasily.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,9:59:00PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"adjustments\":[],\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,9:59:00PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":5,\"scoringVector\":\"AV:N/AC:L/Au:N/C:N/I:P/A:N\",\"source\":\"NVD\",\"version\":\"2.0\"},{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://hackerone.com/reports/1555796\",\"https://security.gentoo.org/glsa/202212-01\",\"https://lists.debian.org/debian-lts-announce/2022/08/msg00017.html\",\"https://www.debian.org/security/2022/dsa-5197\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-27782\",\"vendorCreatedAt\":\"Jun2,2022,2:15:00PM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Jan5,2023,5:51:00PM\",\"vulnerabilityId\":\"CVE-2022-27782\",\"vulnerablePackages\":[{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"libcurl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatelibcurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"},{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"curl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatecurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsEcrContainerImage\":{\"architecture\":\"amd64\",\"imageHash\":\"sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"imageTags\":[\"o3\"],\"platform\":\"ORACLE_LINUX_8\",\"pushedAt\":\"Jan19,2023,7:38:39PM\",\"registry\":\"111122223333\",\"repositoryName\":\"inspector2\"}},\"id\":\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"type\":\"AWS_ECR_CONTAINER_IMAGE\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-27782-libcurl,curl\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,9:59:00PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.value(), testing::HasSubstr("Inspector2 Finding"));
    ASSERT_THAT(result.value(), testing::HasSubstr("ECR image in region us-east-1(111122223333)"));
}

TEST(Inspector, parse_inspector_lambda_finding) {
    std::string msg = "{\"version\":\"0\",\"id\":\"040bb590-3a12-353f-ecb1-05e54b0fbea7\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T19:20:25Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"ThoseusingWoodstoxtoparseXMLdatamaybevulnerabletoDenialofServiceattacks(DOS)ifDTDsupportisenabled.Iftheparserisrunningonusersuppliedinput,anattackermaysupplycontentthatcausestheparsertocrashbystackoverflow.Thiseffectmaysupportadenialofserviceattack.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,7:20:25PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,7:20:25PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=47434\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-40152\",\"vendorCreatedAt\":\"Sep16,2022,10:15:00AM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Nov25,2022,11:15:00AM\",\"vulnerabilityId\":\"CVE-2022-40152\",\"vulnerablePackages\":[{\"epoch\":0,\"filePath\":\"lib/woodstox-core-6.2.7.jar\",\"fixedInVersion\":\"6.4.0\",\"name\":\"com.fasterxml.woodstox:woodstox-core\",\"packageManager\":\"JAR\",\"remediation\":\"Updatewoodstox-coreto6.4.0\",\"version\":\"6.2.7\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsLambdaFunction\":{\"architectures\":[\"X86_64\"],\"codeSha256\":\"+EwrOrht2um4fdVCD73gj+O7HJIAUvUxi8AD0eKHSkc=\",\"executionRoleArn\":\"arn:aws:iam::111122223333:role/ExampleFunction-ExecutionRole\",\"functionName\":\"Example-function\",\"lastModifiedAt\":\"Nov7,2022,8:29:27PM\",\"packageType\":\"ZIP\",\"runtime\":\"JAVA_11\",\"version\":\"$LATEST\"}},\"id\":\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"tags\":{\"TargetAlias\":\"DeploymentStack\",\"SoftwareType\":\"Infrastructure\"},\"type\":\"AWS_LAMBDA_FUNCTION\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-40152-com.fasterxml.woodstox:woodstox-core\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,7:20:25PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.value(), testing::HasSubstr("Inspector2 Finding"));
    ASSERT_THAT(result.value(), testing::HasSubstr("lambda function in region us-east-1(111122223333)"));
}

TEST(Inspector, parse_initial_scan) {
    std::string msg = "{\"version\":\"0\",\"id\":\"b119d033-8f00-72dc-cd8c-4975d21a13c8\",\"detail-type\":\"Inspector2 Scan\",\"source\":\"aws.inspector2\",\"account\":\"123456789123\",\"time\":\"2024-04-24T07:00:47Z\",\"region\":\"eu-west-1\",\"resources\":[\"arn:aws:ecr:eu-west-1:123456789123:repository/server-api-api-primary\"],\"detail\":{\"scan-status\":\"INITIAL_SCAN_COMPLETE\",\"repository-name\":\"arn:aws:ecr:eu-west-1:123456789123:repository/server-api-api-primary\",\"finding-severity-counts\":{\"CRITICAL\":2,\"HIGH\":0,\"MEDIUM\":3,\"TOTAL\":8},\"image-digest\":\"sha256:2083110ca27464385af2e2aaf4a2ce37cee9a12d4ea679c1f38a5038bb99f056c\",\"image-tags\":[],\"version\":\"1.0\"}}";
    std::string expected = "{\"blocks\":[{\"text\":{\"text\":\"Inspector2 Scan in region eu-west-1(123456789123)\",\"type\":\"plain_text\"},\"type\":\"header\"},{\"text\":{\"text\":\"*Repository*\\n`arn:aws:ecr:eu-west-1:123456789123:repository/server-api-api-primary`\",\"type\":\"mrkdwn\"},\"type\":\"section\"},{\"fields\":[{\"text\":\"*CRITICAL*\\n2\",\"type\":\"mrkdwn\"},{\"text\":\"*HIGH*\\n0\",\"type\":\"mrkdwn\"},{\"text\":\"*MEDIUM*\\n3\",\"type\":\"mrkdwn\"},{\"text\":\"*TOTAL*\\n8\",\"type\":\"mrkdwn\"}],\"type\":\"section\"}],\"channel\":\"slack_channel\",\"text\":\"*Inspector2 Scan in eu-west-1*\"}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_EQ(result.value(), expected);
}

TEST(Inspector, parse_initial_scan_only_lasted_tag) {
    std::string msg = "{\"version\":\"0\",\"id\":\"b119d033-8f00-72dc-cd8c-4975d21a13c8\",\"detail-type\":\"Inspector2 Scan\",\"source\":\"aws.inspector2\",\"account\":\"123456789123\",\"time\":\"2024-04-24T07:00:47Z\",\"region\":\"eu-west-1\",\"resources\":[\"arn:aws:ecr:eu-west-1:123456789123:repository/server-api-api-primary\"],\"detail\":{\"scan-status\":\"INITIAL_SCAN_COMPLETE\",\"repository-name\":\"arn:aws:ecr:eu-west-1:123456789123:repository/server-api-api-primary\",\"finding-severity-counts\":{\"CRITICAL\":2,\"HIGH\":0,\"MEDIUM\":3,\"TOTAL\":8},\"image-digest\":\"sha256:2083110ca27464385af2e2aaf4a2ce37cee9a12d4ea679c1f38a5038bb99f056c\",\"image-tags\":[],\"version\":\"1.0\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{true, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_FALSE(result.has_value());
}

// TEST(Inspector, parse_inspector_ec2_finding) {
//     std::string msg = "{\n  \"version\": \"0\",\n  \"id\": \"efb7474e-473e-dfb6-c5fb-6476e2a875f3\",\n  \"detail-type\": \"Inspector2 Finding\",\n  \"source\": \"aws.inspector2\",\n  \"account\": \"123456789012\",\n  \"time\": \"2022-04-01T16:38:07Z\",\n  \"region\": \"us-east-1\",\n  \"resources\": [\"arn:aws:ecr:us-east-1:123456789012:repository/my-repo\", \"i-12345678\"],\n  \"detail\": {\n    \"awsAccountId\": \"123456789012\",\n    \"description\": \"Multiple integer overflows in libwebp allows attackers to have unspecified impact via unknown vectors.\",\n    \"findingArn\": \"arn:aws:inspector2:us-east-1:123456789012:finding/FINDING_ID\",\n    \"firstObservedAt\": \"Apr 1, 2022, 4:38:07 PM\",\n    \"inspectorScore\": 7.8,\n    \"inspectorScoreDetails\": {\n      \"adjustedCvss\": {\n        \"adjustments\": [],\n        \"cvssSource\": \"REDHAT_CVE\",\n        \"score\": 7.8,\n        \"scoreSource\": \"REDHAT_CVE\",\n        \"scoringVector\": \"CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\",\n        \"version\": \"3.1\"\n      }\n    },\n    \"lastObservedAt\": \"Apr 1, 2022, 4:38:07 PM\",\n    \"packageVulnerabilityDetails\": {\n      \"cvss\": [{\n        \"baseScore\": 7.8,\n        \"scoringVector\": \"CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H\",\n        \"source\": \"REDHAT_CVE\",\n        \"version\": \"3.1\"\n      }, {\n        \"baseScore\": 4.6,\n        \"scoringVector\": \"AV:L/AC:L/Au:N/C:P/I:P/A:P\",\n        \"source\": \"NVD\",\n        \"version\": \"2.0\"\n      }],\n      \"referenceUrls\": [],\n      \"source\": \"REDHAT_CVE\",\n      \"sourceUrl\": \"https://access.redhat.com/security/cve/CVE-2018-25020\",\n      \"vendorCreatedAt\": \"May 17, 2018, 12:00:00 AM\",\n      \"vendorSeverity\": \"Moderate\",\n      \"vulnerabilityId\": \"CVE-2018-25020\",\n      \"vulnerablePackages\": [{\n        \"arch\": \"X86_64\",\n        \"epoch\": 0,\n        \"name\": \"kernel\",\n        \"packageManager\": \"OS\",\n        \"release\": \"200.489.amzn2\",\n        \"version\": \"4.14.262\"\n      }]\n    },\n    \"remediation\": {\n      \"recommendation\": {\n        \"text\": \"The default Red Hat Enterprise Linux kernel prevents unprivileged users from being able to use eBPF by the kernel.unprivileged_bpf_disabled sysctl. This would require a privileged user with CAP_SYS_ADMIN or root to be able to abuse this flaw reducing its attack space.\\n\\nFor the Red Hat Enterprise Linux 7 the eBPF for unprivileged users is always disabled.\\nFor the Red Hat Enterprise Linux 8 to confirm the current state, inspect the sysctl with the command:\\n\\n# cat /proc/sys/kernel/unprivileged_bpf_disabled\\n\\nThe setting of 1 would mean that unprivileged users can not use eBPF, mitigating the flaw.\"\n      }\n    },\n    \"resources\": [{\n      \"details\": {\n        \"awsEc2Instance\": {\n          \"iamInstanceProfileArn\": \"arn:aws:iam::123456789012:my-profile/my-role\",\n          \"imageId\": \"ami-033eb06b56512a90f\",\n          \"ipV4Addresses\": [\"3.84.189.204\", \"172.31.89.59\"],\n          \"ipV6Addresses\": [],\n          \"launchedAt\": \"Apr 1, 2022, 4:36:48 PM\",\n          \"platform\": \"AMAZON_LINUX_2\",\n          \"subnetId\": \"subnet-7aceba5b\",\n          \"type\": \"c4.large\",\n          \"vpcId\": \"vpc-56eb6e2b\"\n        }\n      },\n      \"id\": \"i-07543563af836b6a8\",\n      \"partition\": \"aws\",\n      \"region\": \"us-east-1\",\n      \"type\": \"AWS_EC2_INSTANCE\"\n    }],\n    \"severity\": \"HIGH\",\n    \"status\": \"ACTIVE\",\n    \"title\": \"CVE-2018-25020 - kernel\",\n    \"type\": \"PACKAGE_VULNERABILITY\",\n    \"updatedAt\": \"Apr 1, 2022, 4:38:07 PM\"\n  }\n}";
//     nlohmann::json json;
//     auto jsonMessage = json.parse(msg);
//     Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{}};
//     inspector.parse(jsonMessage);
//     auto result = inspector.message();
//     ASSERT_THAT(result.value(), testing::HasSubstr("Inspector2 Finding"));
//     ASSERT_THAT(result.value(), testing::HasSubstr("EC2 instance in region us-east-1(111122223333)"));
// }
TEST(Inspector, parse_inspector_lambda_finding_with_friendly_account_name) {
    std::string msg = "{\"version\":\"0\",\"id\":\"040bb590-3a12-353f-ecb1-05e54b0fbea7\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T19:20:25Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"ThoseusingWoodstoxtoparseXMLdatamaybevulnerabletoDenialofServiceattacks(DOS)ifDTDsupportisenabled.Iftheparserisrunningonusersuppliedinput,anattackermaysupplycontentthatcausestheparsertocrashbystackoverflow.Thiseffectmaysupportadenialofserviceattack.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,7:20:25PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,7:20:25PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=47434\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-40152\",\"vendorCreatedAt\":\"Sep16,2022,10:15:00AM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Nov25,2022,11:15:00AM\",\"vulnerabilityId\":\"CVE-2022-40152\",\"vulnerablePackages\":[{\"epoch\":0,\"filePath\":\"lib/woodstox-core-6.2.7.jar\",\"fixedInVersion\":\"6.4.0\",\"name\":\"com.fasterxml.woodstox:woodstox-core\",\"packageManager\":\"JAR\",\"remediation\":\"Updatewoodstox-coreto6.4.0\",\"version\":\"6.2.7\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsLambdaFunction\":{\"architectures\":[\"X86_64\"],\"codeSha256\":\"+EwrOrht2um4fdVCD73gj+O7HJIAUvUxi8AD0eKHSkc=\",\"executionRoleArn\":\"arn:aws:iam::111122223333:role/ExampleFunction-ExecutionRole\",\"functionName\":\"Example-function\",\"lastModifiedAt\":\"Nov7,2022,8:29:27PM\",\"packageType\":\"ZIP\",\"runtime\":\"JAVA_11\",\"version\":\"$LATEST\"}},\"id\":\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"tags\":{\"TargetAlias\":\"DeploymentStack\",\"SoftwareType\":\"Infrastructure\"},\"type\":\"AWS_LAMBDA_FUNCTION\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-40152-com.fasterxml.woodstox:woodstox-core\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,7:20:25PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 0.0, "slack_channel", std::optional<std::string>{"friendly-account-name"}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.value(), testing::HasSubstr("lambda function in region us-east-1(friendly-account-name)"));
}
TEST(Inspector, if_inspector_score_lower_than_severity_threshold_return_empty) {
    std::string msg = "{\"version\":\"0\",\"id\":\"040bb590-3a12-353f-ecb1-05e54b0fbea7\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T19:20:25Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"ThoseusingWoodstoxtoparseXMLdatamaybevulnerabletoDenialofServiceattacks(DOS)ifDTDsupportisenabled.Iftheparserisrunningonusersuppliedinput,anattackermaysupplycontentthatcausestheparsertocrashbystackoverflow.Thiseffectmaysupportadenialofserviceattack.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,7:20:25PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,7:20:25PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=47434\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-40152\",\"vendorCreatedAt\":\"Sep16,2022,10:15:00AM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Nov25,2022,11:15:00AM\",\"vulnerabilityId\":\"CVE-2022-40152\",\"vulnerablePackages\":[{\"epoch\":0,\"filePath\":\"lib/woodstox-core-6.2.7.jar\",\"fixedInVersion\":\"6.4.0\",\"name\":\"com.fasterxml.woodstox:woodstox-core\",\"packageManager\":\"JAR\",\"remediation\":\"Updatewoodstox-coreto6.4.0\",\"version\":\"6.2.7\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsLambdaFunction\":{\"architectures\":[\"X86_64\"],\"codeSha256\":\"+EwrOrht2um4fdVCD73gj+O7HJIAUvUxi8AD0eKHSkc=\",\"executionRoleArn\":\"arn:aws:iam::111122223333:role/ExampleFunction-ExecutionRole\",\"functionName\":\"Example-function\",\"lastModifiedAt\":\"Nov7,2022,8:29:27PM\",\"packageType\":\"ZIP\",\"runtime\":\"JAVA_11\",\"version\":\"$LATEST\"}},\"id\":\"arn:aws:lambda:us-east-1:111122223333:function:ExampleFunction:$LATEST\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"tags\":{\"TargetAlias\":\"DeploymentStack\",\"SoftwareType\":\"Infrastructure\"},\"type\":\"AWS_LAMBDA_FUNCTION\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-40152-com.fasterxml.woodstox:woodstox-core\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,7:20:25PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{false, 10.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.has_value(), false);
}

TEST(Inspector, if_latest_enabled_should_not_return_ECR_findings_with_no_tag_latest) {
    std::string msg = "{\"version\":\"0\",\"id\":\"5b52952e-26df-3a51-6d14-4dbe737e58ec\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T21:59:00Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"libcurlwouldreuseapreviouslycreatedconnectionevenwhenaTLSorSSHrelatedoptionhadbeenchangedthatshouldhaveprohibitedreuse.libcurlkeepspreviouslyusedconnectionsinaconnectionpoolforsubsequenttransferstoreuseifoneofthemmatchesthesetup.However,severalTLSandSSHsettingswereleftoutfromtheconfigurationmatchchecks,makingthemmatchtooeasily.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,9:59:00PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"adjustments\":[],\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,9:59:00PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":5,\"scoringVector\":\"AV:N/AC:L/Au:N/C:N/I:P/A:N\",\"source\":\"NVD\",\"version\":\"2.0\"},{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://hackerone.com/reports/1555796\",\"https://security.gentoo.org/glsa/202212-01\",\"https://lists.debian.org/debian-lts-announce/2022/08/msg00017.html\",\"https://www.debian.org/security/2022/dsa-5197\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-27782\",\"vendorCreatedAt\":\"Jun2,2022,2:15:00PM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Jan5,2023,5:51:00PM\",\"vulnerabilityId\":\"CVE-2022-27782\",\"vulnerablePackages\":[{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"libcurl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatelibcurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"},{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"curl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatecurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsEcrContainerImage\":{\"architecture\":\"amd64\",\"imageHash\":\"sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"imageTags\":[\"o3\"],\"platform\":\"ORACLE_LINUX_8\",\"pushedAt\":\"Jan19,2023,7:38:39PM\",\"registry\":\"111122223333\",\"repositoryName\":\"inspector2\"}},\"id\":\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"type\":\"AWS_ECR_CONTAINER_IMAGE\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-27782-libcurl,curl\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,9:59:00PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{true, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.has_value(), false);
}

TEST(Inspector, ECR_tag_is_latest_and_onlylatest_is_enabled) {
    std::string msg = "{\"version\":\"0\",\"id\":\"5b52952e-26df-3a51-6d14-4dbe737e58ec\",\"detail-type\":\"Inspector2 Finding\",\"source\":\"aws.inspector2\",\"account\":\"111122223333\",\"time\":\"2023-01-19T21:59:00Z\",\"region\":\"us-east-1\",\"resources\":[\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\"],\"detail\":{\"awsAccountId\":\"111122223333\",\"description\":\"libcurlwouldreuseapreviouslycreatedconnectionevenwhenaTLSorSSHrelatedoptionhadbeenchangedthatshouldhaveprohibitedreuse.libcurlkeepspreviouslyusedconnectionsinaconnectionpoolforsubsequenttransferstoreuseifoneofthemmatchesthesetup.However,severalTLSandSSHsettingswereleftoutfromtheconfigurationmatchchecks,makingthemmatchtooeasily.\",\"exploitAvailable\":\"NO\",\"findingArn\":\"arn:aws:inspector2:us-east-1:111122223333:finding/FINDING_ID\",\"firstObservedAt\":\"Jan19,2023,9:59:00PM\",\"fixAvailable\":\"YES\",\"inspectorScore\":7.5,\"inspectorScoreDetails\":{\"adjustedCvss\":{\"adjustments\":[],\"cvssSource\":\"NVD\",\"score\":7.5,\"scoreSource\":\"NVD\",\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"version\":\"3.1\"}},\"lastObservedAt\":\"Jan19,2023,9:59:00PM\",\"packageVulnerabilityDetails\":{\"cvss\":[{\"baseScore\":5,\"scoringVector\":\"AV:N/AC:L/Au:N/C:N/I:P/A:N\",\"source\":\"NVD\",\"version\":\"2.0\"},{\"baseScore\":7.5,\"scoringVector\":\"CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N\",\"source\":\"NVD\",\"version\":\"3.1\"}],\"referenceUrls\":[\"https://hackerone.com/reports/1555796\",\"https://security.gentoo.org/glsa/202212-01\",\"https://lists.debian.org/debian-lts-announce/2022/08/msg00017.html\",\"https://www.debian.org/security/2022/dsa-5197\"],\"relatedVulnerabilities\":[],\"source\":\"NVD\",\"sourceUrl\":\"https://nvd.nist.gov/vuln/detail/CVE-2022-27782\",\"vendorCreatedAt\":\"Jun2,2022,2:15:00PM\",\"vendorSeverity\":\"HIGH\",\"vendorUpdatedAt\":\"Jan5,2023,5:51:00PM\",\"vulnerabilityId\":\"CVE-2022-27782\",\"vulnerablePackages\":[{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"libcurl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatelibcurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"},{\"arch\":\"X86_64\",\"epoch\":0,\"fixedInVersion\":\"0:7.61.1-22.el8_6.3\",\"name\":\"curl\",\"packageManager\":\"OS\",\"release\":\"22.el8\",\"remediation\":\"yumupdatecurl\",\"sourceLayerHash\":\"sha256:38a980f2cc8accf69c23deae6743d42a87eb34a54f02396f3fcfd7c2d06e2c5b\",\"version\":\"7.61.1\"}]},\"remediation\":{\"recommendation\":{\"text\":\"NoneProvided\"}},\"resources\":[{\"details\":{\"awsEcrContainerImage\":{\"architecture\":\"amd64\",\"imageHash\":\"sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"imageTags\":[\"latest\"],\"platform\":\"ORACLE_LINUX_8\",\"pushedAt\":\"Jan19,2023,7:38:39PM\",\"registry\":\"111122223333\",\"repositoryName\":\"inspector2\"}},\"id\":\"arn:aws:ecr:us-east-1:111122223333:repository/inspector2/sha256:98f0304b3a3b7c12ce641177a99d1f3be56f532473a528fda38d53d519cafb13\",\"partition\":\"aws\",\"region\":\"us-east-1\",\"type\":\"AWS_ECR_CONTAINER_IMAGE\"}],\"severity\":\"HIGH\",\"status\":\"ACTIVE\",\"title\":\"CVE-2022-27782-libcurl,curl\",\"type\":\"PACKAGE_VULNERABILITY\",\"updatedAt\":\"Jan19,2023,9:59:00PM\"}}";
    nlohmann::json json;
    auto jsonMessage = json.parse(msg);
    Inspector inspector{true, 0.0, "slack_channel", std::optional<std::string>{}};
    inspector.parse(jsonMessage);
    auto result = inspector.message();
    ASSERT_THAT(result.has_value(), true);
}